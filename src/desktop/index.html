<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DaviProjects - Gestión de Proyectos</title>
    <meta name="theme-color" content="#082359">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="DaviProjects">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/img/logo.webp">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/src/desktop/style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/src/shared/supabase-config.js"></script>
    <script src="/src/shared/notification-helper.js"></script>
    <script>
        // Redirección responsiva dinámica
        function checkRedirection() {
            if (window.innerWidth <= 768) {
                window.location.replace("/src/mobile/index.html" + window.location.search);
            }
        }
        window.addEventListener('resize', checkRedirection);
        checkRedirection();

        // Reforzar actualización de Service Worker si es necesario
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                window.location.reload();
            });
        }
    </script>
    <style>
        #app { display: none; } /* Ocultar hasta validar sesión */
        .loading-screen {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #082359;
            color: white;
            font-family: 'Inter', sans-serif;
            position: relative;
            padding: 30px 0;
            box-sizing: border-box;
        }

        .spinner-loading {
            width: 30px;
            height: 30px;
            border: 3px solid rgba(255,255,255,0.1);
            border-top: 3px solid #05A64B;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .powered-by-loading {
            margin-top: 50px;
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 50px;
            opacity: 0.85;
            border: 1px solid rgba(255, 255, 255, 0.1);
            white-space: nowrap;
        }
        .powered-by-loading span {
            font-size: 0.65rem;
            font-weight: 700;
            letter-spacing: 2px;
            color: rgba(255,255,255,0.7);
            text-transform: uppercase;
        }
        .powered-by-loading img {
            height: 26px;
            width: auto;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }
    </style>
    <script>
        // Service Worker Registration handled by Helper
        if (window.NotificationHelper) {
            NotificationHelper.registerServiceWorker();
        }

        // Obligatoriedad de versión v40 (Bypass splash)
        const APP_VERSION = '40.0.0';
        const savedVersion = localStorage.getItem('app_version');
        if (savedVersion && savedVersion !== APP_VERSION) {
            console.log('Versión antigua detectada en PC. Forzando actualización...');
            if ('caches' in window) {
                caches.keys().then(names => {
                    for (let name of names) caches.delete(name);
                });
            }
            localStorage.setItem('app_version', APP_VERSION);
            window.location.reload();
        } else if (!savedVersion) {
            localStorage.setItem('app_version', APP_VERSION);
        }

        function showCustomAlert(title, message, type = 'warning') {
            const overlay = document.createElement('div');
            overlay.className = 'custom-alert-overlay';
            const icon = type === 'success' ? 'fa-check-circle' : (type === 'error' ? 'fa-times-circle' : 'fa-exclamation-triangle');
            overlay.innerHTML = `
                <div class="custom-alert-card">
                    <div class="alert-icon ${type}"><i class="fas ${icon}"></i></div>
                    <div class="alert-title">${title}</div>
                    <div class="alert-msg">${message}</div>
                    <div class="alert-actions">
                        <button class="alert-btn">Entendido</button>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);
            return new Promise((resolve) => {
                overlay.querySelector('.alert-btn').onclick = () => {
                    overlay.remove();
                    resolve();
                };
            });
        }

        async function checkAccess() {
            try {
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) 
                    || window.matchMedia("(max-width: 768px)").matches;
                
                if (isMobile) {
                    window.location.replace("../mobile/index.html" + window.location.search);
                    return;
                }

                // Esperar a que AuthService esté disponible
                let retry = 0;
                while (typeof AuthService === 'undefined' && retry < 10) {
                    await new Promise(r => setTimeout(r, 100));
                    retry++;
                }

                if (typeof AuthService === 'undefined') throw new Error("Timeout loading AuthService");

                const session = await AuthService.getSession();
                if (!session) {
                    const currentUrl = encodeURIComponent(window.location.href);
                    window.location.replace("auth/login.html?redirect=" + currentUrl);
                    return;
                }

                // VALIDACIÓN ESTRICTA: Solo usuarios en daviplata_usuarios
                try {
                    const profile = await AuthService.getUserProfile(session.user.id);
                    if (!profile) {
                         await AuthService.logout(true);
                         return;
                    }
                    window.session = session;
                } catch (profError) {
                    console.error("Error validando perfil:", profError);
                    const currentUrl = encodeURIComponent(window.location.href);
                    window.location.replace("auth/login.html?expired=1&redirect=" + currentUrl);
                }
            } catch (err) {
                console.error("Critical access error:", err);
                window.location.replace("auth/login.html");
            }
        }
        checkAccess();
    </script>
</head>
<body>
    <audio id="notifSound" src="https://cdnjs.cloudflare.com/ajax/libs/ion-sound/3.0.7/sounds/button_tiny.mp3" preload="auto"></audio>
    <audio id="global-music-audio" preload="auto"></audio>
    <div id="loading" class="loading-screen">
        <div class="spinner-loading"></div>
        <div style="font-weight: 500; letter-spacing: 0.5px; opacity: 0.8;">Cargando...</div>
        
        <div class="powered-by-loading">
            <span>Powered by</span>
            <img src="../../img/lpsolutionslogo/png/lpsolutionswithe.webp" alt="LPSolutions Logo">
        </div>
    </div>
    <div id="app">
        <button id="btn-fab-project" class="fab-project admin-only hidden" title="Nuevo Proyecto">
            <i class="fas fa-plus"></i>
        </button>
        <div id="main-container">
            <aside class="sidebar closed" id="sidebar">
                <div class="sidebar-top">
                    <div class="logo">
                        <img src="../../img/logo.webp" alt="Logo" style="height: 32px; width: auto; margin-right: 10px;">
                        <span>DaviProjects</span>
                        <button id="btn-close-sidebar" class="btn-icon-only"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="sidebar-header">
                        <h2>Menú Principal</h2>
                    </div>
                    <ul class="sidebar-nav">
                        <li id="nav-dashboard" class="active">
                            <i class="fas fa-chart-line"></i> Dashboard
                        </li>
                        <li id="nav-projects">
                            <i class="fas fa-folder-open"></i> Proyectos
                        </li>
                        <li id="nav-ideas">
                            <i class="fas fa-lightbulb"></i> Ideas
                        </li>
                        <li id="nav-music">
                            <i class="fas fa-music"></i> Música
                        </li>
                    </ul>
                    <div class="sidebar-header" style="margin-top: 1.5rem;">
                        <h2>Proyectos</h2>
                        <button id="btn-new-project" class="admin-only" title="Nuevo Proyecto"><i class="fas fa-plus"></i></button>
                    </div>
                    <ul id="project-list">
                        <!-- Projects will be loaded here -->
                    </ul>
                </div>
                <div class="sidebar-footer">
                    <div class="powered-by-sidebar">
                        <span>Powered by</span>
                        <img src="../../img/lpsolutionslogo/png/lpsolutionswithe.webp" alt="LPSolutions Logo">
                    </div>
                </div>
            </aside>

            <main class="content">
                <header class="content-header">
                    <div class="header-left">
                        <button id="btn-open-sidebar" class="btn-hamburger"><i class="fas fa-bars"></i></button>
                        <h1 id="current-project-name">DaviProjects</h1>
                        <button id="btn-edit-members" class="btn-secondary hidden" style="margin-left: 1rem; padding: 0.4rem 0.8rem; font-size: 0.8rem;">
                            <i class="fas fa-users-cog"></i> Miembros
                        </button>
                        <div class="view-switch hidden" id="view-controls" style="margin-left: 2rem;">
                            <button id="btn-view-kanban" class="active">
                                <i class="fas fa-columns"></i>
                                <span>Kanban</span>
                            </button>
                            <button id="btn-view-history">
                                <i class="fas fa-history"></i>
                                <span>Registro Profesional</span>
                            </button>
                        </div>
                    </div>
                    <div class="header-right">
                        <div class="user-profile">
                            <div class="user-info-text">
                                <span id="user-display-name">Usuario</span>
                            </div>
                            <div class="avatar">U</div>
                            <button id="btn-notifications" class="btn-home-circle" title="Habilitar Notificaciones">
                                <i class="fas fa-bell"></i>
                            </button>
                            <button id="btn-home" class="btn-home-circle" title="Ir al Dashboard">
                                <i class="fas fa-home"></i>
                            </button>
                            <button id="btn-logout" class="btn-logout-circle" title="Cerrar Sesión">
                                <i class="fas fa-power-off"></i>
                            </button>
                        </div>
                    </div>
                </header>

                <section id="gallery-view" class="view">
                    <div class="dashboard-header">
                        <div class="brand-badge">
                            <img src="../../img/logo.webp" alt="Logo">
                            <span>DaviProjects</span>
                        </div>
                        <div class="welcome-text">
                            <h2 id="dashboard-welcome-msg">¡Hola de nuevo!</h2>
                            <p>Aquí tienes un resumen de tus proyectos y tareas.</p>
                        </div>
                    </div>

                    <div class="metrics-grid">
                        <div id="btn-dashboard-new-idea" class="metric-card" style="cursor: pointer; border: 2px dashed #05A64B; background: #f0fdf4;">
                            <div class="metric-icon success" style="background: #05A64B; color: white;"><i class="fas fa-plus"></i></div>
                            <div class="metric-info">
                                <span class="metric-label" style="color: #05A64B; font-weight: 700;">NUEVA IDEA</span>
                                <span class="metric-value">Anotar</span>
                            </div>
                        </div>
                        <div id="btn-dashboard-music" class="metric-card" style="cursor: pointer; border: 2px solid #007aff; background: #f0f7ff;">
                            <div class="metric-icon" style="background: #007aff; color: white;"><i class="fas fa-music"></i></div>
                            <div class="metric-info">
                                <span class="metric-label" style="color: #007aff; font-weight: 700;">MÚSICA</span>
                                <span class="metric-value">Explorar</span>
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-icon"><i class="fas fa-folder"></i></div>
                            <div class="metric-info">
                                <span class="metric-label">Proyectos</span>
                                <span class="metric-value" id="count-projects">0</span>
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-icon alert"><i class="fas fa-tasks"></i></div>
                            <div class="metric-info">
                                <span class="metric-label">Tareas Pendientes</span>
                                <span class="metric-value" id="count-tasks-pending">0</span>
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-icon success"><i class="fas fa-check-circle"></i></div>
                            <div class="metric-info">
                                <span class="metric-label">Completadas</span>
                                <span class="metric-value" id="count-tasks-done">0</span>
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-icon warning"><i class="fas fa-eye"></i></div>
                            <div class="metric-info">
                                <span class="metric-label">En Revisión</span>
                                <span class="metric-value" id="count-tasks-review">0</span>
                            </div>
                        </div>
                    </div>

                    <div class="section-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <h3>Próximos a Vencer</h3>
                        <button id="btn-view-all-projects" class="btn-view-all" style="background: none; border: 1px solid var(--primary); color: var(--primary); padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; font-weight: 600; font-size: 0.8rem; transition: all 0.2s;">
                            Ver todos los proyectos <i class="fas fa-arrow-right" style="margin-left: 5px;"></i>
                        </button>
                    </div>
                    
                    <div id="project-gallery" class="project-gallery">
                        <!-- Project cards will be rendered here -->
                    </div>
                </section>

                <section id="music-view" class="view hidden">
                    <div class="music-hub-layout">
                        <!-- Rediseño del Header de Música -->
                        <div class="music-hero-card">
                            <div class="hero-content">
                                <div class="hero-text">
                                    <div class="brand-badge-alt">
                                        <i class="fas fa-compact-disc fa-spin"></i>
                                        <span>DREAMNOTES MUSIC</span>
                                    </div>
                                    <h1>Tu sonido, tu proyecto</h1>
                                    <p>Gestiona y escucha todas las producciones musicales vinculadas a tus desarrollos en un solo lugar.</p>
                                    <div class="hero-actions">
                                        <button id="btn-upload-music" class="btn-glass">
                                            <i class="fas fa-plus"></i> Nueva Producción
                                        </button>
                                        <div class="music-search-box">
                                            <i class="fas fa-search"></i>
                                            <input type="text" id="music-search-input" placeholder="Buscar canciones o proyectos...">
                                        </div>
                                    </div>
                                </div>
                                <div class="hero-stats">
                                    <div class="stat-bubble">
                                        <span id="music-total-count">0</span>
                                        <label>Temas</label>
                                    </div>
                                    <div class="stat-bubble">
                                        <span id="music-total-likes">0</span>
                                        <label>Favoritos</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="music-content-body">
                            <!-- Sidebar interna de filtros -->
                            <div class="music-internal-sidebar">
                                <ul class="music-nav-filters">
                                    <li class="active" data-filter="all"><i class="fas fa-th-large"></i> Todos los temas</li>
                                    <li data-filter="favs"><i class="fas fa-heart"></i> Mis Favoritos</li>
                                    <li data-filter="projects"><i class="fas fa-rocket"></i> Por Proyectos</li>
                                </ul>
                                
                                <div class="music-playlist-mini">
                                    <h5>RECIENTES</h5>
                                    <div id="music-recent-small" class="recent-list">
                                        <!-- Mini listado de canciones recientes -->
                                    </div>
                                </div>
                            </div>

                            <!-- Grilla Principal -->
                            <div class="music-main-area">
                                <div class="section-title-row">
                                    <h3 id="music-list-title">Explorar Todo</h3>
                                    <div class="view-options">
                                        <button id="btn-music-grid" class="btn-icon-min active" title="Ver cuadrícula"><i class="fas fa-th"></i></button>
                                        <button id="btn-music-list" class="btn-icon-min" title="Ver lista"><i class="fas fa-list"></i></button>
                                    </div>
                                </div>
                                <div id="music-list" class="music-grid">
                                    <!-- Canciones aquí -->
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="projects-view" class="view hidden">
                    <div id="full-project-gallery" class="project-gallery">
                        <!-- All project cards will be rendered here -->
                    </div>
                </section>

                <section id="ideas-view" class="view hidden">
                    <div class="dashboard-header">
                        <div class="brand-badge">
                            <i class="fas fa-lightbulb" style="color: #fbbf24;"></i>
                            <span>Banco de Ideas</span>
                        </div>
                        <div class="welcome-text">
                            <h2>Tus Chispazos de Creatividad</h2>
                            <p>Convierte tus pensamientos en proyectos reales.</p>
                        </div>
                    </div>
                    
                    <div class="ideas-container">
                        <div class="ideas-section">
                            <div class="ideas-grid" id="ideas-fav-grid">
                                <!-- Favorite ideas here -->
                            </div>
                        </div>

                        <div class="ideas-section" style="margin-top: 2rem;">
                            <h3 id="label-other-ideas" style="margin-bottom: 1.5rem; color: var(--text-muted); font-size: 0.9rem; letter-spacing: 1px; display: none;">OTRAS IDEAS</h3>
                            <div class="ideas-grid" id="ideas-main-grid">
                                <!-- Regular ideas here -->
                            </div>
                        </div>

                        <div class="ideas-section" style="margin-top: 4rem; opacity: 0.7;">
                            <h3 id="label-converted-ideas" style="margin-bottom: 1.5rem; color: var(--text-muted); font-size: 0.9rem; letter-spacing: 1px; display: none;">PROYECTOS CREADOS</h3>
                            <div class="ideas-grid" id="ideas-converted-grid">
                                <!-- Converted ideas here -->
                            </div>
                        </div>
                    </div>
                </section>

                <section id="kanban-view" class="view hidden" style="position: relative;">
                    <div id="pane-loading-kanban" class="pane-loading-overlay hidden">
                        <i class="fas fa-circle-notch fa-spin"></i>
                        <span>Sincronizando tareas...</span>
                    </div>
                    <div class="board">
                        <div class="column" data-status="TODO">
                            <h3><i class="fas fa-list-ul"></i> Por Hacer</h3>
                            <div class="task-list"></div>
                            <button class="btn-add-task"><i class="fas fa-plus"></i> Añadir Tarea</button>
                        </div>
                        <div class="column" data-status="DOING">
                            <h3><i class="fas fa-spinner"></i> En Progreso</h3>
                            <div class="task-list"></div>
                            <button class="btn-add-task"><i class="fas fa-plus"></i> Añadir Tarea</button>
                        </div>
                        <div class="column" data-status="DONE">
                            <h3><i class="fas fa-check-double"></i> Finalizado</h3>
                            <div class="task-list"></div>
                            <button class="btn-add-task"><i class="fas fa-plus"></i> Añadir Tarea</button>
                        </div>
                        <div class="column" data-status="REVIEW">
                            <h3><i class="fas fa-eye"></i> En Revisión</h3>
                            <div class="task-list"></div>
                        </div>
                        <div class="column" data-status="REJECTED" style="opacity: 0.8;">
                            <h3><i class="fas fa-ban"></i> Rechazado</h3>
                            <div class="task-list"></div>
                        </div>
                    </div>
                </section>

                <section id="history-view" class="view hidden" style="position: relative;">
                    <div id="pane-loading-history" class="pane-loading-overlay hidden">
                        <i class="fas fa-circle-notch fa-spin"></i>
                        <span>Cargando historial...</span>
                    </div>
                    <div class="history-container">
                        <div class="history-header">
                            <h3><i class="fas fa-history"></i> Registro de Actividad</h3>
                            <button id="btn-refresh-history" class="btn-icon-only" style="color: var(--primary);" title="Actualizar"><i class="fas fa-sync-alt"></i></button>
                        </div>
                        <div id="history-list" class="history-list">
                            <!-- Logs will be rendered here -->
                            <div class="history-empty">
                                <i class="fas fa-clipboard-list"></i>
                                <p>No hay registros para este proyecto todavía.</p>
                            </div>
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- Modals -->
    <div id="modal-idea" class="modal hidden">
        <div class="modal-content">
            <button class="modal-close-corner close-modal" title="Cerrar"><i class="fas fa-times"></i></button>
            <div class="modal-priority-banner" style="background: #fbbf24;"></div>
            
            <div style="padding: 2.5rem;">
                <h3 id="idea-modal-title" style="font-size: 1.5rem; color: #0f172a; margin-bottom: 0.5rem;">Anota tu Idea</h3>
                <p id="idea-modal-desc" style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 2rem;">Captúrala rápido antes de que se escape.</p>
                
                <!-- STEP 1: Capture -->
                <div id="idea-step-1">
                    <div class="view-switch" style="margin-bottom: 1.25rem; justify-content: flex-start; gap: 0.5rem;">
                        <button id="btn-mode-text" class="active">Texto</button>
                        <button id="btn-mode-voice">Voz</button>
                    </div>

                    <div id="idea-text-box" class="form-group" style="margin-bottom: 1.5rem;">
                        <textarea id="idea-content" placeholder="¿Qué tienes en mente? Escríbelo aquí..." rows="6" style="width: 100%; padding: 1rem 1.25rem; border-radius: 1rem; border: 2px solid #f1f5f9; font-size: 1.1rem; outline: none; resize: none; font-family: inherit; background: #fffcf0; transition: all 0.2s;"></textarea>
                    </div>

                    <div id="idea-voice-box" class="form-group hidden" style="margin-bottom: 1.5rem;">
                        <div id="idea-rec-container" style="background: #f8fafc; border-radius: 1rem; padding: 1.5rem; display: flex; flex-direction: column; align-items: center; gap: 1rem; border: 2px dashed #cbd5e1;">
                            <div id="idea-rec-timer" style="font-family: monospace; font-size: 1.5rem; color: #64748b;">00:00</div>
                            <div style="display: flex; gap: 1rem;">
                                <button id="btn-idea-rec" class="btn-rec" style="width: 60px; height: 60px; border-radius: 50%; background: #ef4444; color: white; border: none; font-size: 1.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);"><i class="fas fa-microphone"></i></button>
                                <button id="btn-idea-stop" class="hidden" style="width: 60px; height: 60px; border-radius: 50%; background: #0f172a; color: white; border: none; font-size: 1.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center;"><i class="fas fa-stop"></i></button>
                            </div>
                            <div id="idea-audio-preview" class="hidden" style="width: 100%;">
                                <audio id="audio-idea-play" controls style="width: 100%;"></audio>
                            </div>
                        </div>
                    </div>

                    <button id="btn-idea-next" style="width: 100%; background: #0f172a; color: white; border: none; padding: 1rem; border-radius: 0.85rem; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                        Siguiente <i class="fas fa-arrow-right"></i>
                    </button>
                </div>

                <!-- STEP 2: Title -->
                <div id="idea-step-2" class="hidden">
                    <div class="form-group" style="margin-bottom: 2rem;">
                        <label style="display: block; font-size: 0.75rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.75rem; letter-spacing: 0.05em;">Ponle un título a tu idea</label>
                        <input type="text" id="idea-title" placeholder="Ej. Idea para el nuevo canal" style="width: 100%; padding: 1rem 1.25rem; border-radius: 0.85rem; border: 2px solid #0f172a; font-size: 1.1rem; outline: none; background: white;">
                    </div>

                    <div style="display: flex; gap: 1rem;">
                        <button id="btn-idea-back" style="flex: 0.4; background: #f1f5f9; color: #64748b; border: none; padding: 1rem; border-radius: 0.85rem; font-weight: 700; cursor: pointer;">Atrás</button>
                        <button id="save-idea" style="flex: 1; background: #fbbf24; color: #082359; border: none; padding: 1rem; border-radius: 0.85rem; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem; box-shadow: 0 4px 6px -1px rgba(251, 191, 36, 0.3);">
                            <i class="fas fa-save"></i> Guardar Chispazo
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Cargando con Frases -->
    <div id="modal-loading" class="modal hidden" style="z-index: 9999; background: rgba(15, 23, 42, 0.9);">
        <div style="text-align: center; color: white; padding: 2rem; max-width: 500px;">
            <div class="spinner" style="margin: 0 auto 2rem; border-top-color: var(--primary);"></div>
            <h3 id="loading-quote-title" style="font-size: 1.2rem; margin-bottom: 1rem; color: var(--primary);">"Cualquier cosa que valga la pena hacer, vale la pena hacerla bien."</h3>
            <p id="loading-quote-author" style="font-size: 0.9rem; opacity: 0.7; font-style: italic;">– Lord Chesterfield</p>
            <p style="margin-top: 2rem; font-size: 0.8rem; letter-spacing: 0.2em; text-transform: uppercase; color: #64748b;">Procesando ...</p>
        </div>
    </div>

    <!-- Modals Existentes -->
    <div id="modal-project" class="modal admin-only hidden">
        <div class="modal-content">
            <button class="modal-close-corner close-modal" title="Cerrar"><i class="fas fa-times"></i></button>
            <div class="modal-priority-banner" style="background: var(--primary);"></div>
            
            <div style="padding: 2.5rem;">
                <h3 style="font-size: 1.5rem; color: #0f172a; margin-bottom: 0.5rem;">Crear Nuevo Proyecto</h3>
                <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 2rem;">Define el espacio de trabajo para tus próximas metas.</p>
                
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label style="display: block; font-size: 0.75rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.5rem; letter-spacing: 0.05em;">Nombre del Proyecto</label>
                    <input type="text" id="new-project-name" placeholder="Ej. Rediseño Web 2026" style="width: 100%; padding: 0.85rem 1.15rem; border-radius: 0.85rem; border: 2px solid #f1f5f9; font-size: 1rem; outline: none; transition: all 0.2s;">
                </div>

                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label style="display: block; font-size: 0.75rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.5rem; letter-spacing: 0.05em;">Descripción (Opcional)</label>
                    <textarea id="new-project-desc" placeholder="¿De qué trata este proyecto?" rows="3" style="width: 100%; padding: 0.85rem 1.15rem; border-radius: 0.85rem; border: 2px solid #f1f5f9; font-size: 1rem; outline: none; transition: all 0.2s; resize: none; font-family: inherit;"></textarea>
                </div>

                <div class="form-group" style="margin-bottom: 2rem;">
                    <label style="display: block; font-size: 0.75rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.5rem; letter-spacing: 0.05em;">Fecha de Vencimiento</label>
                    <input type="datetime-local" id="new-project-due" style="width: 100%; padding: 0.85rem 1.15rem; border-radius: 0.85rem; border: 2px solid #f1f5f9; font-size: 1rem; outline: none; transition: all 0.2s;">
                </div>

                <div class="form-group" style="margin-bottom: 2rem;">
                    <label style="display: block; font-size: 0.75rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.5rem; letter-spacing: 0.05em;">Asignar Participantes (Mín. 1)</label>
                    <div id="new-project-members-list" style="max-height: 200px; overflow-y: auto; display: flex; flex-direction: column; gap: 0.5rem; background: #f8fafc; padding: 1rem; border-radius: 1rem; border: 2px solid #f1f5f9;">
                        <!-- Se poblará dinámicamente -->
                    </div>
                </div>

                <div class="modal-actions" style="justify-content: flex-end; gap: 1rem;">
                    <button class="close-modal" style="background: #f1f5f9; color: #64748b; border: none; padding: 0.85rem 1.5rem; border-radius: 0.85rem; font-weight: 700; cursor: pointer; transition: all 0.2s;">Cancelar</button>
                    <button id="save-project" style="background: var(--primary); color: white; border: none; padding: 0.85rem 2rem; border-radius: 0.85rem; font-weight: 700; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.25);">Crear Proyecto</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Detalles de Proyecto -->
    <div id="modal-project-details" class="modal hidden">
        <div class="modal-content">
            <button class="modal-close-corner close-modal" title="Cerrar"><i class="fas fa-times"></i></button>
            <div id="details-project-banner" class="modal-priority-banner" style="background: var(--primary);"></div>
            
            <div style="padding: 2.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.5rem; padding-right: 2.5rem;">
                    <div>
                        <h3 id="details-project-name" style="font-size: 1.75rem; color: #0f172a; margin-bottom: 0.25rem;">Proyecto</h3>
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <div id="details-project-status" class="project-badge">Activo</div>
                            <div id="details-project-members" style="display: flex; align-items: center; margin-left: 0.5rem;">
                                <!-- Miembros dinámicos -->
                            </div>
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <span id="details-project-progress-text" style="font-size: 1.5rem; font-weight: 800; color: var(--primary);">0%</span>
                        <p style="font-size: 0.7rem; color: var(--text-muted); margin: 0;">COMPLETADO</p>
                    </div>
                </div>

                <div class="details-section" style="margin-bottom: 2rem;">
                    <label style="display: block; font-size: 0.7rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.5rem; letter-spacing: 0.1em;">Descripción</label>
                    <p id="details-project-desc" style="font-size: 1rem; color: #334155; line-height: 1.6; background: #f8fafc; padding: 1rem; border-radius: 0.75rem; border: 1px solid #e2e8f0; min-height: 40px; margin-bottom: 1rem;">Sin descripción.</p>
                    
                    <!-- Reproductor de Audio (Se muestra si hay URL) -->
                    <div id="details-project-audio-container" class="hidden">
                        <div class="project-details-audio">
                            <div class="audio-main-controls">
                                <button id="btn-audio-details-play" class="btn-audio-main">
                                    <i class="fas fa-play"></i>
                                </button>
                                
                                <div class="audio-timeline-container">
                                    <input type="range" id="audio-details-timeline" class="audio-timeline-slider" value="0" min="0" step="0.1">
                                    <div class="audio-time-info">
                                        <span id="audio-details-current">00:00</span>
                                        <span id="audio-details-duration">00:00</span>
                                    </div>
                                </div>

                                <div class="audio-volume-container">
                                    <i class="fas fa-volume-up" id="icon-audio-details-volume"></i>
                                    <input type="range" id="audio-details-volume" class="volume-slider" value="100" min="0" max="100">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2.5rem;">
                    <div>
                        <label style="display: block; font-size: 0.7rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.5rem; letter-spacing: 0.1em;">Cronograma</label>
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; font-size: 0.9rem;">
                                <i class="fas fa-calendar-plus" style="color: #64748b;"></i>
                                <div>
                                    <span style="display: block; font-size: 0.65rem; color: #94a3b8; font-weight: 700;">INICIO</span>
                                    <span id="details-project-start">--/--/----</span>
                                </div>
                            </div>
                            <div id="details-project-due-container" style="display: flex; align-items: center; gap: 0.75rem; font-size: 0.9rem;">
                                <i class="fas fa-calendar-check" style="color: #ef4444;"></i>
                                <div>
                                    <span style="display: block; font-size: 0.65rem; color: #ef4444; font-weight: 700;">VENCIMIENTO</span>
                                    <span id="details-project-due">--/--/----</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label style="display: block; font-size: 0.7rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.5rem; letter-spacing: 0.1em;">Estadísticas</label>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;" id="details-project-stats">
                            <!-- Stats here -->
                        </div>
                    </div>
                </div>

                <!-- Barra de progreso grande -->
                <div style="margin-bottom: 2.5rem;">
                     <div style="width: 100%; height: 12px; background: #f1f5f9; border-radius: 10px; overflow: hidden; border: 1px solid #e2e8f0;">
                        <div id="details-project-progress-bar" style="width: 0%; height: 100%; background: var(--primary); border-radius: 10px; transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);"></div>
                    </div>
                </div>

                <div style="display: flex; gap: 1rem;">
                    <button class="btn-secondary close-modal" style="flex: 1; padding: 1rem;">Volver</button>
                    <button id="btn-details-open-kanban" style="flex: 1.5; background: var(--primary); color: white; border: none; padding: 1rem; border-radius: 0.85rem; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.75rem; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.25); transition: all 0.2s;">
                        <i class="fas fa-external-link-alt"></i> ABRIR TABLERO DE CONTROL
                    </button>
                    <button id="btn-details-delete" class="btn-logout-circle" style="width: 50px; height: 50px; border-radius: 0.85rem; flex-shrink: 0; margin-left: 0;" title="Eliminar Proyecto">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-task" class="modal hidden">
        <div class="modal-content">
            <!-- Botón cerrar en la esquina superior -->
            <button class="modal-close-corner close-modal" title="Cerrar"><i class="fas fa-times"></i></button>

            <!-- Banner de prioridad dinámico -->
            <div id="modal-priority-banner" class="modal-priority-banner"></div>

            <div class="modal-body">
                <!-- Columna Izquierda: Datos de la Tarea -->
                <div class="task-modal-main">
                    <div class="modal-header-with-edit">
                        <div class="modal-title-group">
                            <h3 id="modal-task-title-display">Nueva Tarea</h3>
                            <p id="modal-task-subtitle">Configura los detalles de tu tarea.</p>
                        </div>
                        <div id="btn-edit-task" class="btn-edit-mode" title="Editar Tarea">
                            <i class="fas fa-pencil-alt"></i>
                        </div>
                    </div>

                    <!-- Formulario (Modo Edición / Creación) -->
                    <div id="task-form-container">
                        <input type="text" id="task-title" placeholder="¿Qué hay que hacer?">
                        <textarea id="task-desc" placeholder="Añade una descripción detallada..." rows="3"></textarea>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 0.5rem;">
                            <div>
                                <label style="font-size: 0.75rem; color: var(--text-muted); font-weight: 600;">VENCIMIENTO</label>
                                <input type="datetime-local" id="task-due" style="margin-top: 0.25rem;">
                            </div>
                            <div>
                                <label style="font-size: 0.75rem; color: var(--text-muted); font-weight: 600;">PRIORIDAD</label>
                                <div class="priority-slider-container">
                                    <input type="range" id="task-priority" class="priority-slider" min="1" max="10" value="1">
                                    <div id="priority-indicator" class="priority-visual-indicator" style="background: #f8fafc; border: 1px solid #e2e8f0;">
                                        <div class="priority-icon-wrapper" id="priority-icon-bg" style="background: #64748b; color: white;">
                                            <i id="priority-icon" class="fas fa-leaf"></i>
                                        </div>
                                        <div style="display: flex; flex-direction: column;">
                                            <span id="priority-text" style="font-weight: 700; font-size: 0.85rem; color: #334155;">P1 - Relajado</span>
                                            <span id="priority-desc" style="font-size: 0.7rem; color: #64748b;">No hay prisa, sin presión.</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Campo Motivo (visible solo si aplica) -->
                    <div id="motivo-field-container" class="hidden">
                        <label style="font-size: 0.75rem; color: var(--text-muted); font-weight: 600;">MOTIVO DE ESTADO</label>
                        <textarea id="task-motivo" placeholder="Explica el motivo del cambio de estado..." rows="2" style="margin-top: 0.5rem;"></textarea>
                    </div>

                    <!-- Vista Informativa (Modo Lectura) -->
                    <div id="task-info-container" class="hidden">
                        <div style="background: #f8fafc; padding: 1.5rem; border-radius: 1rem; border: 1px solid #e2e8f0;">
                            <p id="info-task-desc" style="white-space: pre-wrap; color: #334155; line-height: 1.6;"></p>
                            <div id="info-motivo-box" class="hidden" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px dashed #cbd5e1;">
                                <span style="display: block; font-size: 0.7rem; color: #f59e0b; font-weight: 700; text-transform: uppercase;">Motivo:</span>
                                <p id="info-task-motivo" style="color: #64748b; font-style: italic; font-size: 0.9rem; margin-top: 0.25rem;"></p>
                            </div>
                        </div>
                        <div style="display: flex; gap: 2rem; margin-top: 1rem;">
                            <div>
                                <span style="display: block; font-size: 0.7rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase;">Estado</span>
                                <span id="info-task-status" style="font-weight: 600; font-size: 0.9rem;">PENDIENTE</span>
                            </div>
                            <div>
                                <span style="display: block; font-size: 0.7rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase;">Vencimiento</span>
                                <span id="info-task-due" style="font-weight: 600; font-size: 0.9rem;">Sin fecha</span>
                            </div>
                        </div>

                        <!-- Prioridad en su propia fila más detallada -->
                        <div style="margin-top: 1.5rem; padding-top: 1.25rem; border-top: 2px solid #f8fafc;">
                            <span style="display: block; font-size: 0.7rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; margin-bottom: 0.75rem;">Nivel de Prioridad</span>
                            <div id="info-task-priority-pill" style="display: inline-flex; align-items: center; gap: 1rem; background: #f8fafc; padding: 0.75rem 1.25rem; border-radius: 1.25rem; border: 1px solid #e2e8f0; transition: all 0.3s ease; min-width: 200px;">
                                <div id="info-priority-circle" style="width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: white; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);">
                                    <i id="info-task-priority-icon" class="fas fa-leaf" style="font-size: 1.2rem; color: #64748b;"></i>
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 0.2rem;">
                                    <span id="info-task-priority" style="font-weight: 900; font-size: 1.1rem; color: #334155; line-height: 1;">Prioridad 1</span>
                                    <span id="info-task-priority-label" style="font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; opacity: 0.8;">Relajado</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="modal-actions" style="margin-top: 2rem;">
                        <button id="save-task">Guardar Cambios</button>
                    </div>
                </div>

                <!-- Columna Derecha: Extensiones Mejoradas -->
                <div id="task-extensions-area" class="task-modal-extensions hidden">
                    <div class="extensions-tabs-nav">
                        <button class="tab-link active" data-tab="sec-comments"><i class="fas fa-comments"></i> <span>Chat</span></button>
                        <button class="tab-link" data-tab="sec-checklist"><i class="fas fa-check-square"></i> <span>Check</span></button>
                        <button class="tab-link" data-tab="sec-numbered"><i class="fas fa-list-ol"></i> <span>Pasos</span></button>
                    </div>

                    <div class="tabs-content">
                        <!-- Comentarios (Default) -->
                        <div id="sec-comments" class="tab-pane active">
                            <div id="pane-loading-comments" class="pane-loading-overlay hidden">
                                <i class="fas fa-spinner"></i>
                                <span>SINCRONIZANDO CHAT...</span>
                            </div>

                            <div id="task-discussion-area" class="discussion-area"></div>
                            
                            <!-- Nuevo Contenedor de Input con Previsualización Integrada -->
                            <div class="comment-input-wrapper" id="comment-input-area">
                                <div id="comment-uploading-overlay" class="input-uploading-overlay hidden">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                    <span>SUBIENDO...</span>
                                </div>

                                <!-- Preview de Respuesta (WhatsApp Style) -->
                                <div id="reply-preview" class="reply-preview-container hidden">
                                    <div class="reply-preview-content">
                                        <span id="reply-preview-author" class="reply-author">Autor</span>
                                        <span id="reply-preview-text" class="reply-text">Mensaje original...</span>
                                    </div>
                                    <button onclick="cancelReply()" class="btn-close-reply">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>

                                <div id="comment-attachment-preview" class="hidden">
                                    <div class="preview-content">
                                        <div class="thumbnail-wrapper" style="position: relative;">
                                            <div id="preview-thumbnail" class="preview-thumbnail hidden"></div>
                                            <button id="btn-edit-desktop-preview" class="btn-edit-badge hidden" onclick="openEditorFromPreview()">
                                                <i class="fas fa-magic"></i> Editar Imagen
                                            </button>
                                        </div>
                                        <div id="preview-icon" class="preview-icon">
                                            <i class="fas fa-file"></i>
                                        </div>
                                        <div class="preview-info">
                                            <span id="preview-filename">nombre_del_archivo.pdf</span>
                                            <span id="preview-size">0 KB</span>
                                        </div>
                                        <button id="btn-remove-attachment" title="Quitar adjunto">
                                            <i class="fas fa-times-circle"></i>
                                        </button>
                                    </div>
                                </div>

                                <div class="extension-input-group">
                                    <textarea id="new-comment-text" placeholder="Escribir comentario..." rows="1" oninput="autoResizeTextarea(this)"></textarea>
                                    <button class="btn-icon-secondary" id="btn-trigger-file" title="Adjuntar archivo"><i class="fas fa-paperclip"></i></button>
                                    <input type="file" id="comment-file-input" class="hidden" accept="image/*,audio/*,application/pdf">
                                    <button class="btn-add-element" id="btn-save-comment"><i class="fas fa-paper-plane"></i></button>
                                </div>
                            </div>
                        </div>

                        <!-- Checklist -->
                        <div id="sec-checklist" class="tab-pane">
                            <div id="pane-loading-check" class="pane-loading-overlay hidden">
                                <i class="fas fa-spinner"></i>
                                <span>CARGANDO LISTA...</span>
                            </div>
                            <div id="task-checklist-container" class="extension-list"></div>
                            <div class="extension-input-group" style="position: relative;">
                                <div id="check-uploading-overlay" class="input-uploading-overlay hidden">
                                    <i class="fas fa-sync-alt"></i>
                                </div>
                                <input type="text" id="new-checklist-item" placeholder="Añadir item...">
                                <button class="btn-add-element" id="btn-add-checklist"><i class="fas fa-plus"></i></button>
                            </div>
                        </div>

                        <!-- Numerados -->
                        <div id="sec-numbered" class="tab-pane">
                            <div id="pane-loading-steps" class="pane-loading-overlay hidden">
                                <i class="fas fa-spinner"></i>
                                <span>CARGANDO PASOS...</span>
                            </div>
                            <div id="task-numbered-container" class="extension-list"></div>
                            <div class="extension-input-group" style="position: relative;">
                                <div id="steps-uploading-overlay" class="input-uploading-overlay hidden">
                                    <i class="fas fa-sync-alt"></i>
                                </div>
                                <input type="text" id="new-numbered-item" placeholder="Siguiente paso...">
                                <button class="btn-add-element" id="btn-add-numbered"><i class="fas fa-plus"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div> <!-- Cierre modal-body -->
        </div>
    </div>

    <div id="modal-motivo" class="modal hidden">
        <div class="modal-content modal-mini">
            <div class="modal-header">
                <h3 id="motivo-title">Indique el motivo</h3>
                <p>Por favor, explique brevemente por qué cambia el estado de esta tarea.</p>
            </div>
            
            <div class="modal-inner">
                <div class="form-group">
                    <textarea id="custom-motivo-input" placeholder="Escriba aquí el motivo..."></textarea>
                </div>
            </div>

            <div class="modal-footer">
                <button id="cancel-motivo" class="btn-secondary">Cancelar</button>
                <button id="confirm-motivo" class="btn-primary">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal para zoom de imagen -->
    <div id="modal-image-zoom" class="modal hidden" style="background: rgba(0,0,0,0.9);">
        <button class="modal-close-corner close-zoom" style="top: 20px; right: 20px;"><i class="fas fa-times"></i></button>
        <div class="zoom-container">
            <img id="zoomed-image" src="" alt="Zoom">
            <div class="zoom-controls">
                <button id="btn-zoom-out"><i class="fas fa-search-minus"></i></button>
                <button id="btn-zoom-reset">100%</button>
                <button id="btn-zoom-in"><i class="fas fa-search-plus"></i></button>
            </div>
        </div>
    </div>

    <!-- REPRODUCTOR DE AUDIO FLOTANTE (PC) -->
    <div id="floating-audio-player" class="audio-player-bar hidden">
        <div class="player-content glass">
            <div class="player-left">
                <div class="player-icon-box pulse-audio" id="player-main-icon"><i class="fas fa-volume-up"></i></div>
                <div class="player-meta">
                    <span class="p-title" id="player-song-title">Nota de audio</span>
                    <span id="player-time" class="p-timer">0:00 / 0:00</span>
                </div>
                <!-- Reacciones integradas en el player para música -->
                <div id="player-music-reactions" class="p-reactions hidden" style="display: flex; gap: 10px; margin-left: 15px; padding-left: 15px; border-left: 1px solid rgba(0,0,0,0.1);">
                    <button id="player-btn-like" class="p-btn-react"><i class="fas fa-heart"></i> <span id="player-count-like">0</span></button>
                    <button id="player-btn-dislike" class="p-btn-react"><i class="fas fa-heart-broken"></i> <span id="player-count-dislike">0</span></button>
                </div>
            </div>
            
            <div class="player-center">
                <div class="p-controls">
                    <button id="player-play-btn" class="p-btn-main"><i class="fas fa-play"></i></button>
                </div>
                <div class="p-timeline-box">
                    <input type="range" id="player-timeline" class="p-slider" min="0" value="0" step="0.1">
                    <div id="player-bar-track" class="p-track"></div>
                </div>
            </div>

            <div class="player-right">
                <div class="p-volume-box">
                    <i class="fas fa-volume-down" id="p-v-icon"></i>
                    <div class="p-vol-container">
                        <input type="range" id="player-volume" class="p-slider-vol" min="0" max="1" step="0.01" value="1">
                        <div id="player-volume-track" class="p-vol-track"></div>
                    </div>
                </div>
                <button id="player-download-btn" class="p-btn-action" title="Descargar"><i class="fas fa-download"></i></button>
                <button id="player-close-btn" class="p-btn-action" title="Cerrar"><i class="fas fa-times"></i></button>
            </div>
        </div>
    </div>

    <!-- Modal para Nueva Música PC -->
    <div id="modal-upload-music" class="modal hidden">
        <div class="modal-content studio-modal">
            <div class="modal-header">
                <h3><i class="fas fa-record-vinyl fa-spin" style="color: #05a64b;"></i> DreamNotes Music Studio</h3>
                <button class="modal-close" id="close-music-modal"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="studio-form-grid">
                    <div class="form-group full">
                        <label><i class="fas fa-signature"></i> Nombre de la canción</label>
                        <input type="text" id="pc-music-name" placeholder="Ej: Master Final Mix">
                    </div>
                    
                    <div class="form-group half">
                        <label><i class="fas fa-info-circle"></i> Versión / Descripción</label>
                        <input type="text" id="pc-music-desc" placeholder="Ej: v2.0 Bass Boost">
                    </div>
                    
                    <div class="form-group half">
                        <label><i class="fas fa-rocket"></i> Vincular a Proyecto</label>
                        <select id="pc-music-project">
                            <!-- Dinámico -->
                        </select>
                    </div>

                    <div class="form-group full">
                        <label><i class="fas fa-file-audio"></i> Archivo de Audio (MP3/WAV)</label>
                        <div class="file-upload-wrapper">
                            <input type="file" id="pc-music-file" accept="audio/*">
                            <div class="file-upload-design">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <span>Arrastra o selecciona tu obra maestra</span>
                            </div>
                        </div>
                    </div>

                    <div class="form-group full">
                        <label><i class="fas fa-pen-nib"></i> Letra o Notas de Producción</label>
                        <textarea id="pc-music-lyrics" placeholder="Escribe aquí la letra o notas importantes..."></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="btn-cancel-music-pc" class="btn-studio-sec">Descartar</button>
                <button id="btn-do-upload-music" class="btn-studio-pri">Sincronizar y Guardar</button>
            </div>
        </div>
    </div>

    <!-- MODAL: GESTIÓN DE MIEMBROS (ADMIN SOLO) -->
    <div id="modal-project-members" class="modal hidden">
        <div class="modal-content">
            <div class="modal-close-corner close-modal">
                <i class="fas fa-times"></i>
            </div>
            
            <div class="modal-header-with-edit">
                <div class="modal-title-group">
                    <span class="modal-category">ADMINISTRACIÓN</span>
                    <h1>Gestionar Miembros del Proyecto</h1>
                    <p>Selecciona los usuarios que tendrán acceso a este espacio de trabajo.</p>
                </div>
            </div>

            <div class="modal-body">
                <div class="members-gallery-container">
                    <div class="search-members-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="search-users" placeholder="Buscar usuarios por nombre o email...">
                    </div>
                    
                    <div id="users-gallery-grid" class="users-gallery-grid">
                        <!-- Cards dinámicas de usuarios -->
                        <div class="loader-container">
                            <div class="spinner-loading"></div>
                            <span>Cargando usuarios...</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <div class="selected-count-badge">
                        <i class="fas fa-users"></i> <span id="members-count">0</span> miembros
                    </div>
                </div>
                <button class="btn-primary-alt close-modal" style="background: #05A64B; color: white; border: none; padding: 0.8rem 2rem; border-radius: 50px; font-weight: 700;">
                    Listo, Guardar Cambios
                </button>
            </div>
        </div>
    </div>

    <script src="/src/shared/storage.js"></script>
    <script src="/src/shared/chat-utils.js"></script>
    <script src="/src/shared/image-editor.js"></script>
    <script src="/src/shared/image-viewer.js"></script>
    <script src="/src/desktop/script.js"></script>
</body>
</html>
